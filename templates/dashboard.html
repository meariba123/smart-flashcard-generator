{% extends "layout.html" %}
{% block content %}
<div class="dashboard-wrapper">
    <div class="welcome-banner">
        <h1>Welcome, {{ session.username }}! Ready to turn your notes into knowledge?</h1>
        <div class="action-cards">
            <div class="info-card">
                <h3>1. Upload Notes</h3>
                <p>Select your CS lecture files to extract key concepts.</p>
            </div>
            <div class="info-card">
                <h3>2. View Flashcards</h3>
                <p>Organized by AI confidence scores.</p>
            </div>
            <div class="info-card">
                <h3>3. Review & Quiz</h3>
                <p>Monitor your progress through quizzes.</p>
            </div>
        </div>
    </div>

    <div class="upload-section">
        <h3>Start a New Study Set</h3>
        <form id="uploadForm" class="drop-zone">
            <p>Drag and drop your file here, or click to browse.</p>
            <input type="file" id="notesFile" hidden accept=".pdf,.docx,.txt">
            <button type="button" onclick="document.getElementById('notesFile').click()" class="btn-study">Choose file</button>
            <div id="uploadStatus"></div>
        </form>
    </div>

    <div class="dashboard-layout">
        <div class="sets-grid">
            {% for set in sets %}
            {% set score = set.avg_score | default(0.5) %}
            <div class="set-card {% if score >= 0.8 %}border-green{% elif score >= 0.5 %}border-amber{% else %}border-red{% endif %}">
                <h3>{{ set.name }}</h3>
                <p>Cards: {{ set.count | default(0) }}</p>

                <div class="status-icon {% if score >= 0.8 %}bg-green{% elif score >= 0.5 %}bg-amber{% else %}bg-red{% endif %}">
                    {% if score >= 0.8 %}✓{% elif score >= 0.5 %}?{% else %}✕{% endif %}
                </div>

                <p><strong>{% if score >= 0.8 %}High Confidence{% elif score >= 0.5 %}Medium Confidence{% else %}Low Confidence{% endif %}</strong></p>
                
                <a href="{{ url_for('view_set', set_id=set._id) }}" class="btn-study">Study Now</a>
            </div>
            {% endfor %}
        </div>

        <aside class="progress-sidebar">
            <h3>Set Progress</h3>
            <div class="circular-mastery">
                <span style="font-size: 24px; font-weight: bold;">65%</span>
                <span>Mastered</span>
            </div>
            <p><span style="color:var(--success-green)">●</span> Mastered: 15</p>
            <p><span style="color:var(--warning-amber)">●</span> Reviewing: 5</p>
            <p><span style="color:#ddd">●</span> New: 4</p>
            <hr>
            <h4>Recent Activity</h4>
            <p><small>Completed "Psychology Quiz 1" - 85%</small></p>
        </aside>
    </div>
</div>

<script>
    const fileInput = document.getElementById('notesFile');
    const uploadStatus = document.getElementById('uploadStatus');

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            const formData = new FormData();
            formData.append('notes_file', fileInput.files[0]);
            uploadStatus.innerHTML = "Processing CS notes...";

            fetch('{{ url_for("upload_notes_ajax") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.redirect) window.location.href = data.redirect;
                else uploadStatus.innerHTML = "Error: " + data.error;
            });
        }
    });
</script>
{% endblock %}
