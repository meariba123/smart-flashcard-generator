{% extends "layout.html" %}
{% block content %}
<div class="dashboard-container">
  <h2 class="dashboard-title">Welcome, {{ session.username }}</h2>

  <!-- Upload / Drag Area -->
  <form id="uploadForm" class="upload-area" enctype="multipart/form-data" onsubmit="return false;">
    <div class="upload-icon">ðŸ“¤</div>
    <p>Upload or drag a file here</p>
    <small>Supported: PDF, Word, PowerPoint, Images, TXT</small>

    <input
      id="notesFile"
      type="file"
      name="notes_file"
      accept=".txt,.doc,.docx,.pdf,.ppt,.pptx,.png,.jpg,.jpeg"
      style="display:none"
      required
    />
    <button id="uploadBtn" type="button" aria-label="Choose file">Choose file</button>

    <div id="uploadStatus" style="margin-top:12px"></div>
  </form>
</div>

<script>
  const uploadArea = document.querySelector('.upload-area');
  const fileInput = document.getElementById('notesFile');
  const uploadBtn = document.getElementById('uploadBtn');
  const uploadStatus = document.getElementById('uploadStatus');

  function setLoading(isLoading){
    if(isLoading){
      uploadStatus.innerHTML = '<span class="loading-dot">Generating flashcardsâ€¦</span>';
      uploadArea.classList.add('dragover');
      uploadBtn.disabled = true;
    } else {
      uploadStatus.textContent = '';
      uploadArea.classList.remove('dragover');
      uploadBtn.disabled = false;
    }
  }

  function startUpload(file){
    if(!file){ return; }
    const formData = new FormData();
    formData.append('notes_file', file);
    setLoading(true);

    fetch('{{ url_for('upload_notes_ajax') }}', { method:'POST', body: formData })
      .then(r => r.json())
      .then(data => {
        if(data.error){
          uploadStatus.innerHTML = `<span style="color:#c0392b">${data.error}</span>`;
          setLoading(false);
          return;
        }
        if(data.redirect){
          window.location.assign(data.redirect);
        } else {
          uploadStatus.innerHTML = '<span style="color:#c0392b">Unexpected response.</span>';
          setLoading(false);
        }
      })
      .catch(err => {
        console.error(err);
        uploadStatus.innerHTML = '<span style="color:#c0392b">Upload failed. Try again.</span>';
        setLoading(false);
      });
  }

  // Button triggers file chooser
  uploadBtn.addEventListener('click', () => fileInput.click());

  // Auto-upload on selection
  fileInput.addEventListener('change', () => {
    if(fileInput.files.length > 0){ startUpload(fileInput.files[0]); }
  });

  // Drag & drop
  ['dragenter','dragover'].forEach(evt => uploadArea.addEventListener(evt,(e)=>{e.preventDefault(); uploadArea.classList.add('dragover');}));
  ['dragleave','drop'].forEach(evt => uploadArea.addEventListener(evt,(e)=>{e.preventDefault(); uploadArea.classList.remove('dragover');}));
  uploadArea.addEventListener('drop',(e)=>{ const f = e.dataTransfer.files?.[0]; if(f){ startUpload(f); } });
</script>

<!-- Flashcard Sets Section -->
<div class="sets-container">
  <h3>Your Flashcard Sets</h3>
  {% if sets %}
    <ul class="sets-list">
      {% for s in sets %}
        <li class="set-item">
          <a href="{{ url_for('view_set', set_id=s._id) }}">ðŸ“‚ {{ s.name }}</a>
          <a href="{{ url_for('review_flashcards', set_id=s._id) }}" class="review-link">â–¶ Review</a>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No sets yet â€” upload notes above to create one!</p>
  {% endif %}
</div>


{% endblock %}
